Создание Telegram бота на Python.

Тема для бота: "Погода и прогноз" — бот, который запрашивает у пользователя название города и возвращает текущую погоду и прогноз на ближайшие дни.

Пошаговая инструкция по созданию бота

Подробная пошаговая инструкция: создание Telegram бота "Погода и прогноз"

**Шаг 1: Создайте бота в Telegram и получите токен**

Откройте Telegram. В поиске найдите бота @BotFather и начните диалог с @BotFather, нажав "Start" или отправив /start. После этого создайте нового бота командой /newbot. Далее введите название вашего бота (например, "WeatherBot"). Введите уникальное имя пользователя (например, weather\_bot).

После этого BotFather даст вам токен — строку вида **123456789:ABCdefGhIJKlmnOPQrstUvwxYZ**. Скопируйте его — он понадобится для работы бота.

**Шаг 2: Зарегистрируйтесь и получите API ключ для сервиса погоды**

Перейдите на сайт [OpenWeatherMap](https://openweathermap.org/ "null"). Зарегистрируйтесь и войдите в личный кабинет. Далее перейдите в раздел "API keys" или "API" и создайте новый API ключ. Скопируйте его — он потребуется для получения данных о погоде.

**Шаг 3: Настройте рабочее окружение**

Установите Python, если его ещё нет — скачайте с [python.org](https://python.org/ "null").

Откройте командную строку или терминал и создайте папку для проекта, например:

\```

mkdir weather\_bot

cd weather\_bot

\```

Создайте виртуальное окружение (опционально, рекомендуется):

\```

python -m venv venv

source venv/bin/activate  # для Linux/Mac

venv\Scripts\activate     # для Windows

\```

Установите необходимые библиотеки:

\```

pip install pytelegrambotapi requests python-dotenv

\```

**Шаг 4: Создайте файл .env для хранения ключей**

В папке проекта создайте файл .env и вставьте туда строки:

\```

CopyBOT\_TOKEN=ваш\_токен\_от\_BotFather

API\_KEY=ваш\_ключ\_от\_OpenWeatherMap

\```

Замените ваш\_токен\_от\_BotFather и ваш\_ключ\_от\_OpenWeatherMap на свои реальные значения.

Пример содержимого файла .env:

CopyBOT\_TOKEN=123456789:ABCdefGhIJKlmnOPQrstUvwxYZ

API\_KEY=abcdef1234567890abcdef1234567890

**Шаг 5: Создайте основной скрипт бота**

В той же папке создайте файл weather\_bot.py и вставьте туда следующий код: 

\```

import os

import telebot

import requests

from dotenv import load\_dotenv

\# Загружаем переменные окружения из файла .env

load\_dotenv()

\# Получаем токен бота и API ключ погоды

BOT\_TOKEN = os.environ.get('BOT\_TOKEN')

API\_KEY = os.environ.get('API\_KEY')

\# Создаем экземпляр бота

bot = telebot.TeleBot(BOT\_TOKEN)

\# Функция для получения данных о погоде

def get\_weather(city):

`    `url = f"http://api.openweathermap.org/data/2.5/weather"

`    `params = {

`        `'q': city,

`        `'appid': API\_KEY,

`        `'units': 'metric',    # измерения в градусах Цельсия

`        `'lang': 'ru'          # язык ответов — русский

`    `}

`    `response = requests.get(url, params=params)

`    `if response.status\_code == 200:

`        `data = response.json()

`        `weather\_desc = data['weather'][0]['description'].capitalize()

`        `temp = data['main']['temp']

`        `humidity = data['main']['humidity']

`        `wind\_speed = data['wind']['speed']

`        `return {

`            `'description': weather\_desc,

`            `'temp': temp,

`            `'humidity': humidity,

`            `'wind\_speed': wind\_speed

`        `}

`    `else:

`        `return None

\# Обработка команды /start

@bot.message\_handler(commands=['start'])

def start\_handler(message):

`    `bot.send\_message(

`        `message.chat.id,

`        `"Привет! Я бот погоды. Напиши название города, чтобы получить текущую погоду."

`    `)

\# Обработка любых сообщений (предполагается, что это название города)

@bot.message\_handler(func=lambda msg: True)

def handle\_city(message):

`    `city = message.text.strip()

`    `weather = get\_weather(city)

`    `if weather:

`        `reply = (

`            `f"Погода в {city}:\n"

`            `f"{weather['description']}\n"

`            `f"Температура: {weather['temp']}°C\n"

`            `f"Влажность: {weather['humidity']}%\n"

`            `f"Скорость ветра: {weather['wind\_speed']} м/с"

`        `)

`    `else:

`        `reply = "Не удалось получить данные о погоде. Проверьте название города и попробуйте снова."

`    `bot.send\_message(message.chat.id, reply)

\# Запуск бота

if \_\_name\_\_ == '\_\_main\_\_':

`    `bot.infinity\_polling()

\```

**Шаг 6: Запуск бота**

В командной строке перейдите в папку с проектом и активируйте виртуальное окружение (если создавали):

\```

\# Linux/Mac

source venv/bin/activate

*# Windows*

venv\Scripts\activate

\```

Запустите скрипт: python weather\_bot.py

В Telegram найдите вашего бота по имени, которое вы задали при создании, и отправьте сообщение с названием города (например, "Москва"). Бот должен ответить текущей погодой.

Что делать дальше?

Можно улучшить бота, добавив обработку ошибок, например, если введён неправильный город.

- Можно реализовать прогноз на несколько дней.
- Можно разместить бота на сервере (Heroku, Render), чтобы он работал 24/7.
- Добавить команду /help — чтобы пользователь мог получить список команд.

  Обработка команды /weather для получения погоды по названию города — уже реализована, можно дополнить:

- Добавить возможность получать погоду по геолокации.
- Добавить прогноз на несколько дней (например, 3-дневный прогноз).
- Добавить кнопку для повторных запросов или выбора другого города.
- Обработку ошибок и сообщений для пользователя.

  Ниже представлен код, в котором реализованы эти функции:

  ```

  import os

  import telebot

  import requests

  from dotenv import load\_dotenv

  *# Загружаем переменные окружения из файла .env*

  load\_dotenv()

  *# Получаем токен бота и API ключ погоды*

  BOT\_TOKEN = os.environ.get('BOT\_TOKEN')

  API\_KEY = os.environ.get('API\_KEY')

  *# Создаем экземпляр бота*

  bot = telebot.TeleBot(BOT\_TOKEN)

  *# Функция для получения данных о погоде*

  def get\_weather(city):

  `    `url = "http://api.openweathermap.org/data/2.5/weather"

  `    `params = {

  `        `'q': city,

  `        `'appid': API\_KEY,

  `        `'units': 'metric',    *# измерения в градусах Цельсия*

  `        `'lang': 'ru'          *# язык ответов — русский*

  `    `}

  `    `response = requests.get(url, params=params)

  `    `if response.status\_code == 200:

  `        `data = response.json()

  `        `weather\_desc = data['weather'][0]['description'].capitalize()

  `        `temp = data['main']['temp']

  `        `humidity = data['main']['humidity']

  `        `wind\_speed = data['wind']['speed']

  `        `return {

  `            `'description': weather\_desc,

  `            `'temp': temp,

  `            `'humidity': humidity,

  `            `'wind\_speed': wind\_speed

  `        `}

  `    `else:

  `        `return None

  *# Функция для получения прогноза на 3 дня*

  def get\_forecast(city):

  `    `url = "http://api.openweathermap.org/data/2.5/forecast"

  `    `params = {

  `        `'q': city,

  `        `'appid': API\_KEY,

  `        `'units': 'metric',

  `        `'lang': 'ru'

  `    `}

  `    `response = requests.get(url, params=params)

  `    `if response.status\_code == 200:

  `        `data = response.json()

  `        `forecast\_list = data['list'][:24\*3//3]  *# примерно 3 дня по 3 часа*

  `        `forecast\_text = ""

  `        `for item in forecast\_list:

  `            `dt\_txt = item['dt\_txt']

  `            `desc = item['weather'][0]['description'].capitalize()

  `            `temp = item['main']['temp']

  `            `forecast\_text += f"{dt\_txt}: {desc}, {temp}°C\n"

  `        `return forecast\_text

  `    `else:

  `        `return None

  *# Обработка команды /start*

  @bot.message\_handler(commands=['start'])

  def start\_handler(message):

  `    `bot.send\_message(

  `        `message.chat.id,

  `        `"Привет! Я бот погоды. Напиши название города, чтобы получить текущую погоду. Или отправь свой геопозицию."

  `    `)

  *# Обработка команды /help*

  @bot.message\_handler(commands=['help'])

  def help\_handler(message):

  `    `reply = (

  `        `"/start - начать работу\n"

  `        `"/help - список команд\n"

  `        `"/weather <город> - погода в городе\n"

  `        `"Можно отправлять геолокацию для определения погоды по месту"

  `    `)

  `    `bot.send\_message(message.chat.id, reply)

  *# Обработка команды /weather*

  @bot.message\_handler(commands=['weather'])

  def weather\_command(message):

  `    `parts = message.text.split(maxsplit=1)

  `    `if len(parts) < 2:

  `        `bot.send\_message(message.chat.id, "Пожалуйста, укажите название города. Например: /weather Москва")

  `        `return

  `    `city = parts[1]

  `    `weather = get\_weather(city)

  `    `if weather:

  `        `reply = (

  `            `f"Погода в {city}:\n"

  `            `f"{weather['description']}\n"

  `            `f"Температура: {weather['temp']}°C\n"

  `            `f"Влажность: {weather['humidity']}%\n"

  `            `f"Скорость ветра: {weather['wind\_speed']} м/с"

  `        `)

  `        `bot.send\_message(message.chat.id, reply)

  `        `*# Также можно предложить прогноз*

  `        `forecast = get\_forecast(city)

  `        `if forecast:

  `            `bot.send\_message(message.chat.id, f"Прогноз на ближайшие 3 дня:\n{forecast}")

  `    `else:

  `        `bot.send\_message(message.chat.id, "Не удалось получить погоду. Проверьте название города.")

  *# Обработка сообщений (предполагается, что это название города или команда)*

  @bot.message\_handler(content\_types=['text'])

  def handle\_message(message):

  `    `text = message.text.strip()

  `    `*# Проверка, если пользователь отправил геолокацию*

  `    `if message.content\_type == 'location':

  `        `lat = message.location.latitude

  `        `lon = message.location.longitude

  `        `*# Получение погоды по координатам*

  `        `weather = get\_weather\_by\_coords(lat, lon)

  `        `if weather:

  `            `reply = (

  `                `f"Погода по вашему местоположению:\n"

  `                `f"{weather['description']}\n"

  `                `f"Температура: {weather['temp']}°C\n"

  `                `f"Влажность: {weather['humidity']}%\n"

  `                `f"Скорость ветра: {weather['wind\_speed']} м/с"

  `            `)

  `            `bot.send\_message(message.chat.id, reply)

  `        `else:

  `            `bot.send\_message(message.chat.id, "Не удалось получить погоду по вашему местоположению.")

  `    `else:

  `        `*# Предполагаем, что это название города*

  `        `weather = get\_weather(text)

  `        `if weather:

  `            `reply = (

  `                `f"Погода в {text}:\n"

  `                `f"{weather['description']}\n"

  `                `f"Температура: {weather['temp']}°C\n"

  `                `f"Влажность: {weather['humidity']}%\n"

  `                `f"Скорость ветра: {weather['wind\_speed']} м/с"

  `            `)

  `            `bot.send\_message(message.chat.id, reply)

  `            `*# Предложение прогноза*

  `            `forecast = get\_forecast(text)

  `            `if forecast:

  `                `bot.send\_message(message.chat.id, f"Прогноз на ближайшие 3 дня:\n{forecast}")

  `        `else:

  `            `bot.send\_message(message.chat.id, "Не удалось определить погоду. Попробуйте еще раз или отправьте геолокацию.")

  *# Функция получения погоды по координатам*

  def get\_weather\_by\_coords(lat, lon):

  `    `url = "http://api.openweathermap.org/data/2.5/weather"

  `    `params = {

  `        `'lat': lat,

  `        `'lon': lon,

  `        `'appid': API\_KEY,

  `        `'units': 'metric',

  `        `'lang': 'ru'

  `    `}

  `    `response = requests.get(url, params=params)

  `    `if response.status\_code == 200:

  `        `data = response.json()

  `        `weather\_desc = data['weather'][0]['description'].capitalize()

  `        `temp = data['main']['temp']

  `        `humidity = data['main']['humidity']

  `        `wind\_speed = data['wind']['speed']

  `        `return {

  `            `'description': weather\_desc,

  `            `'temp': temp,

  `            `'humidity': humidity,

  `            `'wind\_speed': wind\_speed

  `        `}

  `    `else:

  `        `return None

  *# Запуск бота*

  if \_\_name\_\_ == '\_\_main\_\_':

  `    `bot.infinity\_polling()

  ```

- Что добавилось:
- Команда /help с описанием команд.
- возможность получать погоду по геолокации.
- получение прогноза на 3 дня.
- обработка сообщений, если пользователь присылает название города или геолокацию.

  Теперь можно добавить интерактивные кнопки (inline-кнопки), чтобы пользователи могли легко получать погоду или запрашивать прогноз, не вводя команды вручную. Что мы получили

1. В /start показываем кнопки: "Погода в городе", "Погода по геолокации", "Помощь". 
1. При нажатии на "Погода в городе" — бот просит ввести название.
1. При нажатии на "Погода по геолокации" — бот ждет отправки геолокации.
1. Реализована обработка нажатий и шагов.
1. Добавлена команда /help через кнопку.
1. Добавлены подменю для получения погоды, прогноза и помощи.
1. Убрана необходимость в обработке callback-кнопок, вместо этого пользователь выбирает опции через меню.

   Что улучшено:

- Меню — приятное и понятное, с кнопками для быстрого выбора.
- Тексты — дружелюбные, информативные, с эмодзи для лучшего восприятия.
- Функциональность — расширены инструкции и добавлены подсказки.
- Обработка — все действия теперь через меню, что удобно и современно.

  Для автоматического получения геоданных (GPS-координат) пользователя в Telegram боте, необходимо обеспечить, чтобы пользователь отправлял свою геолокацию. В Telegram есть встроенная возможность отправлять геоданные (геолокацию), и бот может их принимать автоматически.

  **Чтобы реализовать это, сделаем следующее:**

- Добавим отдельную кнопку "Отправить геолокацию" в меню.
- Обработаем получение геоданных без необходимости пользователь вводить что-либо.
- После получения координат — бот покажет текущую погоду по этим координатам.

  Как это работает:

- Вы добавили кнопку "📍 Отправить геолокацию" в меню.
- Пользователь может нажать её и отправить свою геолокацию.
- Бот автоматически обработает это сообщение типа location и покажет погоду по координатам.

  Важно:

  Пользователи должны нажимать кнопку и разрешать отправлять геоданные. Бот не сможет самостоятельно "читать" GPS или другие устройства — это делают только сами пользователи, отправляя геолокацию. Если нужно автоматизированно получать геоданные без их участия — это невозможно в рамках стандартных возможностей Telegram, так как это нарушает приватность. Поэтому самый оптимальный способ — это именно отправка геолокации пользователем.

  Для этого неоходимо создать кнопку, которая запрашивает геолокацию (request\_location=True). Пользователь нажимает на неё, подтверждает отправку геоданных. После этого бот автоматически получает координаты в обработчике @bot.message\_handler(content\_types=['location']).

  Ключевые моменты:

  Кнопка "Отправить геолокацию" создается с request\_location=True. Она автоматически вызывает отправку геоданных после нажатия пользователем.

  После этого бот получает координаты в обработчике @bot.message\_handler(content\_types=['location']) и выводит погоду.

  Пользователь не должен вручную отправлять геоданные — только нажать кнопку.

  Вот так выглядит код усовершенствованного бота

  ```

  import telebot

  from telebot.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove

  import requests

  import json

  import os

  # Настройки

  TOKEN = "YOUR\_TELEGRAM\_BOT\_TOKEN"

  WEATHER\_API\_KEY = "YOUR\_OPENWEATHERMAP\_API\_KEY"

  FAVORITES\_FILE = "favorites.json"

  bot = telebot.TeleBot(TOKEN)

  # Инициализация файла с избранными городами

  if not os.path.exists(FAVORITES\_FILE):

  `    `with open(FAVORITES\_FILE, 'w') as f:

  `        `json.dump({"users": {}}, f)

  # Клавиатуры

  def main\_menu():

  `    `markup = ReplyKeyboardMarkup(resize\_keyboard=True, row\_width=2)

  `    `markup.add(

  `        `KeyboardButton("🌤 Текущая погода"),

  `        `KeyboardButton("📊 Прогноз на 5 дней"),

  `        `KeyboardButton("❤ Мои любимые города"),

  `        `KeyboardButton("ℹ Помощь")

  `    `)

  `    `return markup

  def weather\_menu():

  `    `markup = ReplyKeyboardMarkup(resize\_keyboard=True, row\_width=2)

  `    `markup.add(

  `        `KeyboardButton("🏙 Ввести город"),

  `        `KeyboardButton("📍 Отправить геолокацию", request\_location=True),

  `        `KeyboardButton("🔙 Назад")

  `    `)

  `    `return markup

  def forecast\_menu():

  `    `markup = ReplyKeyboardMarkup(resize\_keyboard=True, row\_width=2)

  `    `markup.add(

  `        `KeyboardButton("🏙 Прогноз по городу"),

  `        `KeyboardButton("📍 Прогноз по геолокации", request\_location=True),

  `        `KeyboardButton("🔙 Назад")

  `    `)

  `    `return markup

  # Обработчики команд

  @bot.message\_handler(commands=['start'])

  def send\_welcome(message):

  `    `bot.send\_message(

  `        `message.chat.id,

  `        `"👋 Привет! Я бот погоды. Выберите действие:",

  `        `reply\_markup=main\_menu()

  `    `)

  @bot.message\_handler(commands=['help'])

  def send\_help(message):

  `    `show\_help(message.chat.id)

  @bot.message\_handler(func=lambda message: message.text == "ℹ Помощь")

  def send\_help\_button(message):

  `    `show\_help(message.chat.id)

  def show\_help(chat\_id):

  `    `help\_text = """

  ℹ \*Помощь по боту:\*

  🌤 \*Текущая погода\* - показывает погоду в выбранном городе или по вашей геолокации

  📊 \*Прогноз на 5 дней\* - показывает прогноз погоды на 5 дней

  ❤ \*Мои любимые города\* - управление вашими сохраненными городами

  \*Доступные команды:\*

  /start - начать работу с ботом

  /help - показать это сообщение

  /addfavorite - добавить город в избранное

  /removefavorite - удалить город из избранного"""

  `    `bot.send\_message(chat\_id, help\_text, parse\_mode="Markdown")

  # Обработка текстовых сообщений

  @bot.message\_handler(func=lambda message: True)

  def handle\_text(message):

  `    `chat\_id = message.chat.id

  `    `text = message.text

  `    `if text == "🌤 Текущая погода":

  `        `bot.send\_message(

  `            `chat\_id,

  `            `"Выберите способ определения местоположения:",

  `            `reply\_markup=weather\_menu()

  `        `)

  `    `elif text == "📊 Прогноз на 5 дней":

  `        `bot.send\_message(

  `            `chat\_id,

  `            `"Выберите способ определения местоположения для прогноза:",

  `            `reply\_markup=forecast\_menu()

  `        `)

  `    `elif text == "❤ Мои любимые города":

  `        `show\_favorites(chat\_id)

  `    `elif text == "🏙 Ввести город":

  `        `msg = bot.send\_message(

  `            `chat\_id,

  `            `"Введите название города:",

  `            `reply\_markup=ReplyKeyboardRemove()

  `        `)

  `        `bot.register\_next\_step\_handler(msg, process\_city\_step)

  `    `elif text == "🏙 Прогноз по городу":

  `        `msg = bot.send\_message(

  `            `chat\_id,

  `            `"Введите название города для прогноза:",

  `            `reply\_markup=ReplyKeyboardRemove()

  `        `)

  `        `bot.register\_next\_step\_handler(msg, process\_forecast\_city\_step)

  `    `elif text == "🔙 Назад":

  `        `bot.send\_message(

  `            `chat\_id,

  `            `"Главное меню:",

  `            `reply\_markup=main\_menu()

  `        `)

  `    `else:

  `        `bot.send\_message(chat\_id, "Я не понимаю эту команду. Попробуйте /help")

  # Обработка геолокации

  @bot.message\_handler(content\_types=['location'])

  def handle\_location(message):

  `    `chat\_id = message.chat.id

  `    `lat = message.location.latitude

  `    `lon = message.location.longitude

  `    `# Проверяем, откуда пришла геолокация (из какого меню)

  `    `if hasattr(message, 'reply\_markup') and message.reply\_markup and any(btn.text == "📍 Отправить геолокацию" for row in message.reply\_markup.keyboard for btn in row):

  `        `get\_weather\_by\_coords(chat\_id, lat, lon)

  `    `else:

  `        `get\_forecast\_by\_coords(chat\_id, lat, lon)

  # Получение погоды

  def process\_city\_step(message):

  `    `chat\_id = message.chat.id

  `    `city = message.text

  `    `get\_weather\_by\_city(chat\_id, city)

  def get\_weather\_by\_city(chat\_id, city):

  `    `try:

  `        `# Запрос к API погоды

  `        `url = f"http://api.openweathermap.org/data/2.5/weather?q={city}&appid={WEATHER\_API\_KEY}&units=metric&lang=ru"

  `        `response = requests.get(url)

  `        `data = response.json()

  `        `if data["cod"] != 200:

  `            `bot.send\_message(chat\_id, "Город не найден. Попробуйте еще раз.")

  `            `return

            

  `        `weather = {

  `            `'city': data['name'],

  `            `'temp': data['main']['temp'],

  `            `'feels\_like': data['main']['feels\_like'],

  `            `'description': data['weather'][0]['description'],

  `            `'humidity': data['main']['humidity'],

  `            `'wind': data['wind']['speed']

  `        `}

        

  `        `message = f"""

  🌤 \*Погода в {weather['city']}\*

  🌡 Температура: {weather['temp']}°C (ощущается как {weather['feels\_like']}°C)

  ☁ Описание: {weather['description'].capitalize()}

  💧 Влажность: {weather['humidity']}%

  🌬 Ветер: {weather['wind']} м/с"""

  `        `bot.send\_message(chat\_id, message, parse\_mode="Markdown", reply\_markup=main\_menu())

        

  `    `except Exception as e:

  `        `bot.send\_message(chat\_id, "Произошла ошибка. Попробуйте позже.")

  `        `print(e)

  def get\_weather\_by\_coords(chat\_id, lat, lon):

  `    `try:

  `        `url = f"http://api.openweathermap.org/data/2.5/weather?lat={lat}&lon={lon}&appid={WEATHER\_API\_KEY}&units=metric&lang=ru"

  `        `response = requests.get(url)

  `        `data = response.json()

  `        `weather = {

  `            `'city': data['name'],

  `            `'temp': data['main']['temp'],

  `            `'feels\_like': data['main']['feels\_like'],

  `            `'description': data['weather'][0]['description'],

  `            `'humidity': data['main']['humidity'],

  `            `'wind': data['wind']['speed']

  `        `}

  `        `message = f"""

  📍 \*Погода по вашей геолокации ({weather['city']})\*

  🌡 Температура: {weather['temp']}°C (ощущается как {weather['feels\_like']}°C)

  ☁ Описание: {weather['description'].capitalize()}

  💧 Влажность: {weather['humidity']}%

  🌬 Ветер: {weather['wind']} м/с"""

  `        `bot.send\_message(chat\_id, message, parse\_mode="Markdown", reply\_markup=main\_menu())

  `    `except Exception as e:

  `        `bot.send\_message(chat\_id, "Произошла ошибка. Попробуйте позже.")

  `        `print(e)

  # Получение прогноза

  def process\_forecast\_city\_step(message):

  `    `chat\_id = message.chat.id

  `    `city = message.text

  `    `get\_forecast\_by\_city(chat\_id, city)

  def get\_forecast\_by\_city(chat\_id, city):

  `    `try:

  `        `url = f"http://api.openweathermap.org/data/2.5/forecast?q={city}&appid={WEATHER\_API\_KEY}&units=metric&lang=ru"

  `        `response = requests.get(url)

  `        `data = response.json()

  `        `if data["cod"] != "200":

  `            `bot.send\_message(chat\_id, "Город не найден. Попробуйте еще раз.")

  `            `return

  `        `forecast = []

  `        `for item in data['list'][:8]:  # Берем прогноз на ближайшие 24 часа (8 периодов по 3 часа)

  `            `time = item['dt\_txt'][11:16]

  `            `temp = item['main']['temp']

  `            `desc = item['weather'][0]['description']

  `            `forecast.append(f"{time}: {temp}°C, {desc}")

  `        `message = f"""

  📊 \*Прогноз на 24 часа для {data['city']['name']}\*

  {'\n'.join(forecast)}

  """

  `        `bot.send\_message(chat\_id, message, parse\_mode="Markdown", reply\_markup=main\_menu())

        

  `    `except Exception as e:

  `        `bot.send\_message(chat\_id, "Произошла ошибка. Попробуйте позже.")

  `        `print(e)

  def get\_forecast\_by\_coords(chat\_id, lat, lon):

  `    `try:

  `        `url = f"http://api.openweathermap.org/data/2.5/forecast?lat={lat}&lon={lon}&appid={WEATHER\_API\_KEY}&units=metric&lang=ru"

  `        `response = requests.get(url)

  `        `data = response.json()

  `        `forecast = []

  `        `for item in data['list'][:8]:  # Берем прогноз на ближайшие 24 часа (8 периодов по 3 часа)

  `            `time = item['dt\_txt'][11:16]

  `            `temp = item['main']['temp']

  `            `desc = item['weather'][0]['description']

  `            `forecast.append(f"{time}: {temp}°C, {desc}")

  `        `message = f"""

  📍 \*Прогноз на 24 часа по вашей геолокации ({data['city']['name']})\*

  {'\n'.join(forecast)}"""

  `        `bot.send\_message(chat\_id, message, parse\_mode="Markdown", reply\_mup=main\_menu())

  `    `except Exception as e:

  `        `bot.send\_message(chat\_id, "Произошла ошибка. Попробуйте позже.")

  `        `print(e)

  # Работа с избранными городами

  @bot.message\_handler(commands=['addfavorite'])

  def add\_favorite\_command(message):

  `    `msg = bot.send\_message(

  `        `message.chat.id,

  `        `"Введите название города для добавления в избранное:",

  `        `reply\_markup=ReplyKeyboardRemove()

  `    `)

  `    `bot.register\_next\_step\_handler(msg, add\_favorite)

  def add\_favorite(message):

  `    `chat\_id = message.chat.id

  `    `city = message.text

  `    `with open(FAVORITES\_FILE, 'r+') as f:

  `        `data = json.load(f)

  `        `if str(chat\_id) not in data['users']:

  `            `data['users'][str(chat\_id)] = []

  `        `if city not in data['users'][str(chat\_id)]:

  `            `data['users'][str(chat\_id)].append(city)

  `            `f.seek(0)

  `            `json.dump(data, f)

  `            `f.truncate()

  `            `bot.send\_message(

  `                `chat\_id,

  `                `f"Город '{city}' добавлен в избранное!",

  `                `reply\_markup=main\_menu()

  `            `)

  `        `else:

  `            `bot.send\_message(

  `                `chat\_id,

  `                `f"Город '{city}' уже есть в избранном!",

  `                `reply\_markup=main\_menu()

  `            `)

  @bot.message\_handler(commands=['removefavorite'])

  def remove\_favorite\_command(message):

  `    `msg = bot.send\_message(

  `        `message.chat.id,

  `        `"Введите название города для удаления из избранного:",

  `        `reply\_markup=ReplyKeyboardRemove()

  `    `)

  `    `bot.register\_next\_step\_handler(msg, remove\_favorite)

  def remove\_favorite(message):

  `    `chat\_id = message.chat.id

  `    `city = message.text

  `    `with open(FAVORITES\_FILE, 'r+') as f:

  `        `data = json.load(f)

  `        `if str(chat\_id) in data['users'] and city in data['users'][str(chat\_id)]:

  `            `data['users'][str(chat\_id)].remove(city)

  `            `f.seek(0)

  `            `json.dump(data, f)

  `            `f.truncate()

  `            `bot.send\_message(

  `                `chat\_id,

  `                `f"Город '{city}' удален из избранного!",

  `                `reply\_markup=main\_menu()

  `            `)

  `        `else:

  `            `bot.send\_message(

  `                `chat\_id,

  `                `f"Город '{city}' не найден в избранном!",

  `                `reply\_markup=main\_menu()

  `            `)

  def show\_favorites(chat\_id):

  `    `with open(FAVORITES\_FILE, 'r') as f:

  `        `data = json.load(f)

  `        `cities = data['users'].get(str(chat\_id), [])

  `        `if not cities:

  `            `bot.send\_message(

  `                `chat\_id,

  "У вас пока нет избранных городов. Добавьте их с помощью команды /addfavorite",

  `                `reply\_markup=main\_menu()

  `            `)

  `            `return

  `        `markup = ReplyKeyboardMarkup(resize\_keyboard=True, row\_width=2)

  `        `for city in cities:

  `            `markup.add(KeyboardButton(f"🌤 {city}"))

  `        `markup.add(KeyboardButton("🔙 Назад"))

  `        `bot.send\_message(

  `            `chat\_id,

  `            `"Ваши избранные города. Выберите город для просмотра погоды:",

  `            `reply\_markup=markup

  `        `)

  # Запуск бота

  if \_\_name\_\_ == '\_\_main\_\_':

  `    `print("Бот запущен...")

  `    `bot.infinity\_polling()

  ```

  Дополнительные функции бота 

  Вот несколько идей для расширения функциональности бота, которые сделают его ещё более полезным и интересным:

  **1. Погода для нескольких городов (мультиград)**

- Позволять пользователю сохранять список избранных городов и получать обновления по ним.
- Например, команда /favorites или кнопки для добавления/удаления городов.

  **2. Погода сейчас + прогноз на неделю**

- Расширить текущий прогноз на 7 дней и показывать его по запросу.
- Можно выводить краткий ежедневный прогноз или графики (если есть возможность).

  **3. Погода в определённых регионах или странах**

- Например, "Погода в России", "Погода в Европе" — показывать погодные карты или средние показатели.

  **4. Интерактивные уведомления**

- Настраивать ежедневные или утренние уведомления о погоде для пользователя.
- Можно реализовать с помощью inline-кнопок или команд.

  **5. Погода для путешественников**

- Информация о погоде в популярных туристических местах.
- Подсказки по погоде для планирования поездки.

  **6. Погода по времени суток**

- Уведомления или информация о погоде утром, днём, вечером.
- Например, "Какая погода ожидается сегодня вечером?"

  **7. Дополнительная метеоинформация**

- Влажность, давление, UV-индекс, уровень осадков.
- Полезно для людей, занимающихся спортом, путешественников, фермеров.

  **8. Интеграция с погодными картами и радаром**

- Показывать текущие погодные карты, радары осадков, облачности.
- Можно вставлять изображения или ссылки на карты.

  **9. Погода и советы**

- Например, советы по одежде или подготовке к погодным условиям (например, "Сегодня идет дождь — возьмите зонт").

  **10. Календарь погоды**

- Выводить прогноз погоды по датам, например, "Погода на следующую неделю" или "Погода на выходные".

  **11. Интеграция с другими сервисами**

- Например, получать новости о погодных катастрофах или предупреждения.
- Интеграция с OpenWeatherMap или другими погодными API для более точных данных.

  **12. Обратная связь и отзывы**

- Сделать команду для отправки отзывов или пожеланий по работе бота.

